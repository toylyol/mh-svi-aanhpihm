---
title: "Exploring AANHPI Populations using 2018 Minority Health Social Vulnerability Index"
author: "Toyin Ola"
output: 
  ioslides_presentation:
    widescreen: true
params: 
  year: 2018
  sv_threshold: 0.90
  var_threshold: 0.90
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, comment = NA, include = FALSE, cache = FALSE)

```

```{r load-packages, warning = FALSE, message = FALSE}

# The following functions are courtesy of a Stats and R blog post: https://statsandr.com/blog/an-efficient-way-to-install-and-load-r-packages/


# List required packages ----

packages <- c("tidyverse", "reactable", "openxlsx", "here")


# Load all required packages

invisible( lapply(packages, library, character.only = TRUE) )


# Save base path to vector

path <- here()

```

```{r load-data-and-packages}

mh_svi_dd <- read_csv( here("data", "MinorityHealthSVI_DataDictionary_2018.csv"),
                       show_col_types = FALSE)

mh_svi_2018 <- read_csv( here("data", "mh_svi_county_2018.csv"),
                         show_col_types = FALSE)

```

```{r subset-data}

# Subset df to only essential cols ----

mh_svi_lep <- mh_svi_2018 %>%
  mutate( FIPS = ifelse(ST < 10,               # add leading zero to county FIPS as needed
                            paste0("0", FIPS),
                            FIPS)
          ) %>% 
  select(STATE, ST_ABBR, COUNTY, FIPS, EPL_ASIAN, EPL_NHPI, 
         EPL_CHIN, EPL_VIET, EPL_KOR, RPL_THEME3, RPL_THEMES)

```

```{r create-functions}

# Create custom functions to explore data ----

## to identify high-vulnerability counties or high % percentile of any given var

highSVI <- function (df, varname, threshold){
  
  temp <- df %>% filter({{varname}} >= {{threshold}}) 
  
  return(temp)

}

## to identify intersections among the variables of interest

intersectVaribles <- function(df1, df2){
  
  temp <- df1 %>%
    inner_join(df2,
               by = "FIPS",                  # specify primary key col
               keep = FALSE) %>%             # don't retain key col from 2nd df
    select( !ends_with(".y") ) %>%           # remove duplicate cols from 2nd df
    rename_with( ~str_replace(., ".x", "") ) # remove suffix from 2st df colnames
  
  return(temp)

}


# Create custom function for making and prettifying reactables ----

## to format a high-level, summary reactable

prettyReactable <- function(df){
  
  df %>%
    mutate( across(!c(STATE, ST_ABBR, COUNTY, FIPS),      # do not alter these cols
                   scales::label_percent(accuracy = 0.1,  # retain one decimal place
                                         suffix = "%")) 
            ) %>%
    rename(State = STATE, 
           Abbreviation = ST_ABBR, 
           `County Name` = COUNTY, 
           `County FIPS Code` = FIPS, 
           `Percentile of Asian Estimate` = EPL_ASIAN, 
           `Percentile of NHPI Estimate` = EPL_NHPI, 
           `Percentile of Chinese LEP Estimate` = EPL_CHIN, 
           `Percentile of Vietnamese LEP Estimate` = EPL_VIET, 
           `Percentile of Korean LEP Estimate` = EPL_KOR, 
           `Minority Status & Language Percentile Ranking` = RPL_THEME3, 
           `Overall Social Vulnerability Percentile Ranking` = RPL_THEMES) %>%
    reactable(defaultColDef = colDef(align = "left"),   # set default to left align col text
              showPageSizeOptions = TRUE,               # allow user to change rows per page
              pageSizeOptions = c(15, 25, 35),          # delineate options for rows per page
              defaultPageSize = 15,                     # set default rows per page
              sortable = TRUE,
              resizable = TRUE)

}

## to format in-depth reactable for individual focus areas


deepReactable <- function(df, var_name, new_header){
  
  df %>%
  mutate( across(!c(STATE, ST_ABBR, COUNTY, FIPS), 
                   scales::label_percent(accuracy = 0.1,
                                         suffix = "%")) 
            ) %>%
  select(STATE, ST_ABBR, COUNTY, FIPS, {{var_name}}, RPL_THEME3, RPL_THEMES) %>%  
  relocate({{var_name}}, .after = RPL_THEMES) %>%                    # ensure col of interest at beginning
  arrange( desc({{var_name}}) ) %>%
  rename(State = STATE,
         Abbreviation = ST_ABBR, 
        `County Name` = COUNTY, 
        `County FIPS Code` = FIPS,
        {{new_header}} := {{var_name}},                               # note walrus operator
        `Minority Status & Language Percentile Ranking` = RPL_THEME3,
        `Overall Social Vulnerability Percentile Ranking` = RPL_THEMES) %>%
  reactable(defaultColDef = colDef(align = "left"), 
            showPageSizeOptions = TRUE,
            pageSizeOptions = c(15, 25, 35),
            defaultPageSize = 15,
            sortable = TRUE,
            resizable = TRUE
            )
} 
```

## Introduction

- The Minority Health Social Vulnerability Index (SVI) is an extension of the CDC's SVI.
- Both the Minority Health SVI and the CDC SVI are databases that includes many variables associated with a community's ability to prepare for and recover from disasters and public health emergencies. Using these variables, communities are compared to each other and ranked to provide a measure of relative social vulnerability.
- The Minority Health SVI includes specific ethnicity, race, and language data as well as factors like health care infrastructure, chronic disease prevalence, and internet access.
- **This presentation explores Asian American (AA), Native Hawaiian (NH), Pacific Islander (PI), and limited English proficiency (LEP) populations in high-vulnerability counties.**


```{r create-high-sv-table}

# Create a table with all high-vulnerability US counties

h_sv_df <- highSVI(mh_svi_lep, RPL_THEMES, params$sv_threshold) 

h_sv_count <- nrow(h_sv_df) # save number of high-vulnerability counties to vector

```

## High-Vulnerability Counties

- Here, high-vulnerability counties are those with an Overall Social Vulnerability Ranking greater than or equal to `r params$sv_threshold` (≥ `r params$sv_threshold`). 
- This ranking means that a county is more socially vulnerable than 90% of all U.S. counties based.
- of the `r nrow(mh_svi_lep)` U.S. counties, there are `r h_sv_count` high-vulnerability counties that have an Overall Social Vulnerability Ranking ≥ `r params$sv_threshold`.

---

`r prettyReactable(h_sv_df)`

## Appendix

The Minority Health SVI can be explored [online](https://www.minorityhealth.hhs.gov/minority-health-svi/). 

For reference, the following variables were used in this presentation: 

```{r variable-table, include = TRUE}

tribble( ~ `Social Vulnerability Factor`, ~ `Ranking Variable 1`, ~ `Ranking Variable 2`, ~ `Ranking Variable 3`,
         "High Overall Social Vulnerability", "RPL_THEMES", "N/A", "N/A",
         "High Percentage of AANHPI Population", "EPL_ASIAIN", "EPL_NHPI", "N/A",
         "High Percentage of Asian-Language Speakers with LEP", "EPL_CHIN", "EPL_VIET", "EPL_KOR") %>%
  knitr:::kable()

```


## Appendix (continued) 

For easier reading, Minority Health SVI variables and indices were renamed as follows throughout the presentation:

- EPL_ASIAN = Asian Estimate Percentile Ranking
- EPL_NHPI = NHPI Estimate Percentile Ranking
- EPL_CHIN = LEP Chinese Estimate Percentile Ranking
- EPL_VIET = LEP Vietnamese Estimate Percentile Ranking
- EPL_KOR = LEP Korean Estimate Percentile Ranking
- RPL_THEME3 = Minority Status & Language Percentile Ranking
- RPL_THEMES = Overall Social Vulnerability Percentile Ranking 


https://stackoverflow.com/questions/25782595/rmarkdown-ioslides-presentation-in-hd

https://github.com/matteocourthoud/ioslides-theme

https://rstudio-pubs-static.s3.amazonaws.com/840924_1b44cd171dc145e09ebfceb8bfab368b.html

https://emitanaka.org/slides/rladiesSSA2020/
  
https://bookdown.org/yihui/rmarkdown/ioslides-presentation.html
